@using MudBlazor
@using System.ComponentModel.DataAnnotations
@using Frontend.DTOs.Task
@using Microsoft.AspNetCore.Components.Forms
@using Frontend.Services

<MudDialog>
    <DialogContent>
        <EditForm EditContext="@editContext">
            <DataAnnotationsValidator />

            <MudStack Spacing="2">
                <!-- Título -->
                <MudTextField T="string"
                              Label="Título"
                              Variant="Variant.Outlined"
                              @bind-Value="Tarefa.Titulo"
                              Required="true"
                              FullWidth="true"/>

                <!-- Descrição -->
                <MudTextField T="string"
                              Label="Descrição"
                              Variant="Variant.Outlined"
                              @bind-Value="Tarefa.Descricao"
                              TextArea="true"
                              Lines="3"
                              FullWidth="true"/>

                <!-- Preço por hora -->
                <MudNumericField T="decimal?"
                                 Label="Preço/Hora (€)"
                                 Variant="Variant.Outlined"
                                 @bind-Value="Tarefa.PrecoHora"
                                 Min="0"
                                 DecimalPlaces="2"
                                 FullWidth="true"/>
            </MudStack>

            <ValidationSummary />
        </EditForm>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="@Cancel">Cancelar</MudButton>
        <MudButton Color="Color.Primary" OnClick="@SubmitAsync">Criar</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Inject] private TaskService TaskService { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;

    private TaskCreateDto Tarefa { get; set; } = new();
    private EditContext editContext = default!;
    private bool _submitting = false;

    protected override void OnInitialized()
    {
        editContext = new EditContext(Tarefa);
    }

    private async Task SubmitAsync()
    {
        if (!editContext.Validate()) return;

        _submitting = true;
        try
        {
            var result = await TaskService.CreateAsync(Tarefa);
            Snackbar.Add("Tarefa criada com sucesso!", Severity.Success);
            MudDialog.Close(DialogResult.Ok(result));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Erro ao criar tarefa: {ex.Message}", Severity.Error);
        }
        finally
        {
            _submitting = false;
        }
    }

    private void Cancel() => MudDialog.Cancel();
}
