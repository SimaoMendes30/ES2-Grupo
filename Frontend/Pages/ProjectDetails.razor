@page "/project/{ProjetoId:int}"
@using Frontend.DTOs.Projetos
@using Frontend.DTOs.Tarefas
@using Frontend.Services
@inject ProjetoService   ProjetoService
@inject TarefaService    TarefaService
@inject NavigationManager NavigationManager
@inject ISnackbar        Snackbar
@inject IDialogService   DialogService
@layout WorkspaceLayout

<PageTitle>Detalhes do Projeto</PageTitle>

<div class="page-container">
    <div class="glass-side"></div>

    <div style="flex:2;padding:2rem">
        @if (_projeto is null)
        {
            <MudProgressCircular Color="Color.Primary" Indeterminate Size="Size.Large" />
        }
        else
        {
            <!-- ---------- Dados do projeto ---------- -->
            <MudPaper Elevation="4" Class="pa-6 mb-6"
                      Style="background:rgba(255,255,255,.9);border-radius:16px;backdrop-filter:blur(8px)">
                <MudStack Spacing="1">
                    <MudText Typo="Typo.h4" Color="Color.Primary">@_projeto.Nome</MudText>
                    <MudText Typo="Typo.subtitle2">@_projeto.NomeCliente</MudText>

                    <MudDivider Class="my-2"/>

                    <MudText Typo="Typo.body1">@_projeto.Descricao</MudText>

                    <MudStack Row Spacing="4" Class="mt-2">
                        <MudText Typo="Typo.caption"><b>Preço/h:</b> @_projeto.PrecoHora?.ToString("C") ?? "N/D"</MudText>
                        <MudText Typo="Typo.caption"><b>Criado em:</b> @_projeto.DataCriacao?.ToShortDateString() ?? "N/D"</MudText>
                    </MudStack>

                    <MudStack Row Spacing="2" Justify="Justify.FlexEnd" Class="mt-3">
                        <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="DeleteProjeto">
                            Eliminar
                        </MudButton>
                    </MudStack>
                </MudStack>
            </MudPaper>

            <!-- ---------- Tarefas ---------- -->
            <MudPaper Elevation="3" Class="pa-6"
                      Style="background:rgba(255,255,255,.95);border-radius:16px">
                <MudStack Spacing="2">
                    <MudText Typo="Typo.h6" Color="Color.Primary">Tarefas Associadas</MudText>

                    @if (_tarefas is null)
                    {
                        <MudProgressCircular Color="Color.Primary" Indeterminate/>
                    }
                    else if (!_tarefas.Any())
                    {
                        <MudAlert Severity="Severity.Info" Variant="Variant.Filled">
                            Não existem tarefas associadas.
                        </MudAlert>
                    }
                    else
                    {
                        <MudGrid GutterSize="2" RowSpacing="3">
                            @foreach (var t in _tarefas)
                            {
                                <MudItem xs="12" sm="6" md="4">
                                    <MudPaper Class="pa-4" Elevation="2"
                                              Style="background:rgba(255,255,255,.9);border-radius:12px">
                                        <MudStack Spacing="1">
                                            <MudText Typo="Typo.subtitle1" Color="Color.Primary">@t.Descricao</MudText>
                                            <MudText Typo="Typo.caption"><b>Estado:</b> @t.Estado</MudText>
                                            <MudText Typo="Typo.caption"><b>Início:</b> @t.DataInicio.ToShortDateString()</MudText>
                                            <MudText Typo="Typo.caption"><b>Fim:</b> @(t.DataFim?.ToShortDateString() ?? "Em curso")</MudText>

                                            <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                                                <MudMenuItem OnClick="() => TerminarTarefa(t.IdTarefa)">Terminar</MudMenuItem>
                                                <MudMenuItem OnClick="() => RemoverTarefa(t.IdTarefa)">Remover</MudMenuItem>
                                            </MudMenu>
                                        </MudStack>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>
                    }
                </MudStack>
            </MudPaper>
        }
    </div>

    <div class="glass-side"></div>
</div>

@code {
    [Parameter] public int ProjetoId { get; set; }

    private ProjetoDto?              _projeto;
    private IEnumerable<TarefaDto>?  _tarefas;

    /* ---------- ciclo de vida ---------- */
    protected override async Task OnInitializedAsync()
    {
        _projeto = await ProjetoService.GetAsync(ProjetoId);
        _tarefas = await TarefaService.GetByProjetoIdAsync(ProjetoId);
    }

    private async Task RecarregarTarefas()
    {
        _tarefas = await TarefaService.GetByProjetoIdAsync(ProjetoId);
        StateHasChanged();
    }

    /* ---------- ações ---------- */
    private async Task DeleteProjeto()
    {
        var confirm = await DialogService.ShowMessageBox(
            "Eliminar",
            "Tem a certeza que deseja eliminar este projeto?",
            "Sim", "Cancelar");

        if (confirm == true && _projeto is not null)
        {
            if (await ProjetoService.DeleteAsync(_projeto.IdProjeto))
            {
                Snackbar.Add("Projeto eliminado com sucesso.", Severity.Success);
                NavigationManager.NavigateTo("/projetos");
            }
            else Snackbar.Add("Erro ao eliminar o projeto.", Severity.Error);
        }
    }

    private async Task TerminarTarefa(int id)
    {
        await TarefaService.EndAsync(id, new EndTarefaDto(null));
        Snackbar.Add("Tarefa marcada como concluída.", Severity.Success);
        await RecarregarTarefas();
    }

    private async Task RemoverTarefa(int id)
    {
        if (await TarefaService.DeleteAsync(id))
        {
            Snackbar.Add("Tarefa removida com sucesso.", Severity.Info);
            await RecarregarTarefas();
        }
        else Snackbar.Add("Erro ao remover tarefa.", Severity.Error);
    }
}
